<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manajemen ATM - Data AC & Riwayat</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
        }

        body {
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .main-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            margin: 20px;
            padding: 30px;
        }

        .header-section {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            text-align: center;
        }

        .atm-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .atm-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(0,0,0,0.15);
        }

        .atm-header {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            padding: 20px;
        }

        .status-badge {
            font-size: 0.8em;
            padding: 5px 10px;
        }

        .ac-info {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }

        .btn-custom {
            border-radius: 25px;
            padding: 8px 20px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .btn-custom:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .modal-header {
            background: linear-gradient(45deg, #1e3c72, #2a5298);
            color: white;
            border-top-left-radius: 15px;
            border-top-right-radius: 15px;
        }

        .form-control {
            border-radius: 10px;
            border: 2px solid #e9ecef;
            transition: border-color 0.3s ease;
        }

        .form-control:focus {
            border-color: #2a5298;
            box-shadow: 0 0 0 0.2rem rgba(42, 82, 152, 0.25);
        }

        .history-item {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin: 10px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .search-box {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .stats-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner-border {
            color: #2a5298;
        }

        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1080;
        }
    </style>
</head>
<body>
    <div class="container-fluid">
        <div class="main-container">
            <!-- Header -->
            <div class="header-section">
                <h1><i class="fas fa-university"></i> Manajemen ATM KCU Makassar</h1>
                <p class="mb-2">Sistem Monitoring AC dan Riwayat ATM</p>
                <div class="d-flex justify-content-center align-items-center">
                    <span class="badge bg-success me-2" id="firebaseStatus">
                        <i class="fas fa-cloud"></i> Terhubung dengan Firebase
                    </span>
                    <small class="text-white-50">Data tersinkronisasi secara real-time</small>
                </div>
            </div>

            <!-- Statistics -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-university fa-2x text-primary mb-2"></i>
                        <h3 id="totalATM">0</h3>
                        <p>Total ATM</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <h3 id="activeATM">0</h3>
                        <p>ATM Aktif</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-snowflake fa-2x text-info mb-2"></i>
                        <h3 id="acWorking">0</h3>
                        <p>AC Berfungsi</p>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stats-card">
                        <i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>
                        <h3 id="needMaintenance">0</h3>
                        <p>Perlu Maintenance</p>
                    </div>
                </div>
            </div>

            <!-- Search and Add Button -->
            <div class="search-box">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <div class="input-group">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" class="form-control" id="searchInput" placeholder="Cari ATM berdasarkan nama atau alamat...">
                        </div>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-success btn-custom me-2" onclick="exportToCSV()">
                            <i class="fas fa-download"></i> Export CSV
                        </button>
                        <button class="btn btn-primary btn-custom" onclick="openATMModal()" data-bs-toggle="modal" data-bs-target="#atmModal">
                            <i class="fas fa-plus"></i> Tambah ATM Baru
                        </button>
                    </div>
                </div>
            </div>

            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner-border" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2">Memuat data ATM...</p>
            </div>

            <!-- ATM List -->
            <div id="atmList" class="row">
                <!-- ATM cards will be populated here -->
            </div>
        </div>
    </div>

    <!-- ATM Modal -->
    <div class="modal fade" id="atmModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="border-radius: 15px;">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Tambah ATM Baru</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="atmForm">
                        <input type="hidden" id="atmId">
                        
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Nama ATM</label>
                                <input type="text" class="form-control" id="atmName" required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Status ATM</label>
                                <select class="form-control" id="atmStatus">
                                    <option value="aktif">Aktif</option>
                                    <option value="maintenance">Maintenance</option>
                                    <option value="tidak_aktif">Tidak Aktif</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Alamat</label>
                            <textarea class="form-control" id="atmAddress" rows="3" required></textarea>
                        </div>

                        <h6 class="mt-4 mb-3"><i class="fas fa-snowflake"></i> Data AC</h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Merk AC</label>
                                <input type="text" class="form-control" id="acBrand">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Kapasitas (PK)</label>
                                <input type="number" class="form-control" id="acCapacity" step="0.5">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Status AC</label>
                                <select class="form-control" id="acStatus">
                                    <option value="baik">Baik</option>
                                    <option value="perlu_service">Perlu Service</option>
                                    <option value="rusak">Rusak</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Suhu Target (°C)</label>
                                <input type="number" class="form-control" id="acTemp" min="16" max="30" value="24">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Terakhir Service</label>
                                <input type="date" class="form-control" id="lastService">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Service Berikutnya</label>
                                <input type="date" class="form-control" id="nextService">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Catatan AC</label>
                            <textarea class="form-control" id="acNotes" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="button" class="btn btn-primary" onclick="saveATM()">Simpan</button>
                </div>
            </div>
        </div>
    </div>

    <!-- History Modal -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="border-radius: 15px;">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-history"></i> Riwayat ATM</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <input type="text" class="form-control" id="newHistoryEntry" placeholder="Tambahkan catatan riwayat...">
                        </div>
                        <div class="col-md-4">
                            <button class="btn btn-primary w-100" onclick="addHistoryEntry()">
                                <i class="fas fa-plus"></i> Tambah
                            </button>
                        </div>
                    </div>
                    <div id="historyList">
                        <!-- History items will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container">
        <div id="successToast" class="toast" role="alert">
            <div class="toast-header bg-success text-white">
                <i class="fas fa-check-circle me-2"></i>
                <strong class="me-auto">Berhasil</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="successMessage"></div>
        </div>
        
        <div id="errorToast" class="toast" role="alert">
            <div class="toast-header bg-danger text-white">
                <i class="fas fa-exclamation-circle me-2"></i>
                <strong class="me-auto">Error</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
            </div>
            <div class="toast-body" id="errorMessage"></div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>
    
    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyCrpljw48aAYyzsbMqUePgFSDOX-klsCAc",
            authDomain: "atmbanksulselbar.firebaseapp.com",
            projectId: "atmbanksulselbar",
            storageBucket: "atmbanksulselbar.firebasestorage.app",
            messagingSenderId: "261036476120",
            appId: "1:261036476120:web:a5f1598883d3e4b35c79ad",
            measurementId: "G-TY0JHTPDQ6"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const analytics = getAnalytics(app);
        const db = getFirestore(app);

        // Make Firebase functions globally available
        window.db = db;
        window.collection = collection;
        window.addDoc = addDoc;
        window.getDocs = getDocs;
        window.doc = doc;
        window.updateDoc = updateDoc;
        window.deleteDoc = deleteDoc;
        window.onSnapshot = onSnapshot;
    </script>

    <script>
        // Data storage - now using Firebase
        let atmData = [];
        let currentATMId = null;
        let unsubscribe = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App initializing...');
            
            // Wait for Firebase to be loaded
            setTimeout(() => {
                loadATMDataFromFirebase();
                setupRealtimeListener();
            }, 1000);
            
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', function() {
                filterATMs(this.value);
            });

            // Add event listeners for modals
            const atmModal = document.getElementById('atmModal');
            atmModal.addEventListener('hidden.bs.modal', function() {
                console.log('ATM Modal closed');
                currentATMId = null;
            });

            const historyModal = document.getElementById('historyModal');
            historyModal.addEventListener('hidden.bs.modal', function() {
                console.log('History Modal closed');
                currentATMId = null;
            });

            // Add Enter key support for history input
            document.getElementById('newHistoryEntry').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addHistoryEntry();
                }
            });

            console.log('App initialization complete');
        });

        // Setup real-time listener for ATM data
        function setupRealtimeListener() {
            if (unsubscribe) unsubscribe();
            
            // Update Firebase status
            document.getElementById('firebaseStatus').innerHTML = 
                '<i class="fas fa-sync fa-spin"></i> Menyinkronkan...';
            
            unsubscribe = window.onSnapshot(window.collection(window.db, "atms"), (snapshot) => {
                atmData = [];
                snapshot.forEach((doc) => {
                    atmData.push({
                        id: doc.id,
                        ...doc.data()
                    });
                });
                renderATMs();
                updateStatistics();
                
                // Update Firebase status
                document.getElementById('firebaseStatus').innerHTML = 
                    '<i class="fas fa-cloud-check"></i> Tersinkronisasi dengan Firebase';
                
                // Show sync notification (only after initial load)
                if (atmData.length > 0) {
                    console.log('Data tersinkronisasi dari Firebase');
                }
            }, (error) => {
                console.error("Error in real-time listener:", error);
                document.getElementById('firebaseStatus').innerHTML = 
                    '<i class="fas fa-cloud-exclamation"></i> Error koneksi Firebase';
                document.getElementById('firebaseStatus').className = 'badge bg-danger me-2';
            });
        }

        // Load ATM data from Firebase
        async function loadATMDataFromFirebase() {
            document.getElementById('loading').style.display = 'block';
            
            try {
                const querySnapshot = await window.getDocs(window.collection(window.db, "atms"));
                atmData = [];
                
                if (querySnapshot.empty) {
                    // If no data exists, add sample data
                    await addSampleData();
                } else {
                    querySnapshot.forEach((doc) => {
                        atmData.push({
                            id: doc.id,
                            ...doc.data()
                        });
                    });
                }
                
                renderATMs();
                updateStatistics();
                showToast('success', 'Data ATM berhasil dimuat dari Firebase');
            } catch (error) {
                console.error("Error loading ATM data:", error);
                showToast('error', 'Gagal memuat data ATM dari Firebase');
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        // Add sample data to Firebase
        async function addSampleData() {
            const sampleData = [
                {
                    name: "ATM Cabang Utama Makassar",
                    address: "Jl. DR. Ratulangi No. 16, Kel. Mangkura, Kec. Ujung Pandang, Kota Makassar",
                    status: "aktif",
                    acBrand: "Daikin",
                    acCapacity: 2,
                    acStatus: "baik",
                    acTemp: 24,
                    lastService: "2024-12-15",
                    nextService: "2025-03-15",
                    acNotes: "AC berfungsi dengan baik",
                    history: [
                        { date: "2024-12-15", entry: "Service rutin AC dilakukan" },
                        { date: "2024-11-20", entry: "Pembersihan filter AC" }
                    ],
                    createdAt: new Date().toISOString()
                },
                {
                    name: "ATM Drive Thru KONI Sulsel",
                    address: "Jl. Sultan Hasanuddin No. 42, Kel. Sawerigading, Kec. Ujung Pandang, Kota Makassar",
                    status: "aktif",
                    acBrand: "LG",
                    acCapacity: 1.5,
                    acStatus: "perlu_service",
                    acTemp: 26,
                    lastService: "2024-10-10",
                    nextService: "2025-01-10",
                    acNotes: "AC kurang dingin, perlu pengecekan freon",
                    history: [
                        { date: "2024-10-10", entry: "Service AC terakhir" },
                        { date: "2024-12-20", entry: "Laporan AC kurang dingin dari petugas" }
                    ],
                    createdAt: new Date().toISOString()
                }
            ];

            for (const atm of sampleData) {
                await window.addDoc(window.collection(window.db, "atms"), atm);
            }
        }

        // Render ATM cards
        function renderATMs(data = atmData) {
            console.log('Rendering ATMs:', data.length, 'items');
            const atmList = document.getElementById('atmList');
            atmList.innerHTML = '';

            if (data.length === 0) {
                atmList.innerHTML = `
                    <div class="col-12">
                        <div class="text-center p-5">
                            <i class="fas fa-university fa-3x text-muted mb-3"></i>
                            <h5 class="text-muted">Belum ada data ATM</h5>
                            <p class="text-muted">Klik "Tambah ATM Baru" untuk menambahkan data ATM pertama</p>
                        </div>
                    </div>
                `;
                return;
            }

            data.forEach((atm, index) => {
                console.log(`Rendering ATM ${index + 1}:`, atm.name, 'ID:', atm.id);
                
                const statusClass = {
                    'aktif': 'success',
                    'maintenance': 'warning',
                    'tidak_aktif': 'danger'
                };

                const acStatusClass = {
                    'baik': 'success',
                    'perlu_service': 'warning',
                    'rusak': 'danger'
                };

                const card = `
                    <div class="col-lg-6 col-xl-4">
                        <div class="atm-card">
                            <div class="atm-header">
                                <div class="d-flex justify-content-between align-items-start">
                                    <h5 class="mb-1">${atm.name}</h5>
                                    <span class="badge bg-${statusClass[atm.status] || 'secondary'} status-badge">${(atm.status || 'unknown').replace('_', ' ').toUpperCase()}</span>
                                </div>
                                <p class="mb-0"><i class="fas fa-map-marker-alt"></i> ${(atm.address || '').substring(0, 60)}...</p>
                            </div>
                            <div class="card-body p-3">
                                <div class="ac-info">
                                    <h6><i class="fas fa-snowflake text-info"></i> Informasi AC</h6>
                                    <div class="row">
                                        <div class="col-6">
                                            <small class="text-muted">Merk:</small><br>
                                            <strong>${atm.acBrand || '-'}</strong>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Kapasitas:</small><br>
                                            <strong>${atm.acCapacity || '-'} PK</strong>
                                        </div>
                                    </div>
                                    <div class="row mt-2">
                                        <div class="col-6">
                                            <small class="text-muted">Status:</small><br>
                                            <span class="badge bg-${acStatusClass[atm.acStatus] || 'secondary'}">${(atm.acStatus || 'unknown').replace('_', ' ')}</span>
                                        </div>
                                        <div class="col-6">
                                            <small class="text-muted">Suhu:</small><br>
                                            <strong>${atm.acTemp || 24}°C</strong>
                                        </div>
                                    </div>
                                    ${atm.acNotes ? `<div class="mt-2"><small class="text-muted">Catatan:</small><br><small>${atm.acNotes}</small></div>` : ''}
                                </div>
                                
                                <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                                    <button class="btn btn-outline-primary btn-custom btn-sm" onclick="viewHistory('${atm.id}')">
                                        <i class="fas fa-history"></i> Riwayat
                                    </button>
                                    <button class="btn btn-outline-secondary btn-custom btn-sm" onclick="editATM('${atm.id}')">
                                        <i class="fas fa-edit"></i> Edit
                                    </button>
                                    <button class="btn btn-outline-danger btn-custom btn-sm" onclick="deleteATM('${atm.id}')">
                                        <i class="fas fa-trash"></i> Hapus
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                atmList.innerHTML += card;
            });
            
            console.log('ATM rendering complete');
        }

        // Update statistics
        function updateStatistics() {
            const total = atmData.length;
            const active = atmData.filter(atm => atm.status === 'aktif').length;
            const acWorking = atmData.filter(atm => atm.acStatus === 'baik').length;
            const needMaintenance = atmData.filter(atm => 
                atm.acStatus === 'perlu_service' || atm.acStatus === 'rusak' || atm.status === 'maintenance'
            ).length;

            document.getElementById('totalATM').textContent = total;
            document.getElementById('activeATM').textContent = active;
            document.getElementById('acWorking').textContent = acWorking;
            document.getElementById('needMaintenance').textContent = needMaintenance;
        }

        // Filter ATMs
        function filterATMs(searchTerm) {
            const filtered = atmData.filter(atm =>
                atm.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                atm.address.toLowerCase().includes(searchTerm.toLowerCase())
            );
            renderATMs(filtered);
        }

        // Open ATM modal for adding new ATM
        function openATMModal() {
            currentATMId = null;
            document.getElementById('modalTitle').textContent = 'Tambah ATM Baru';
            document.getElementById('atmForm').reset();
            document.getElementById('atmId').value = '';
        }

        // Edit ATM
        function editATM(id) {
            const atm = atmData.find(a => a.id === id);
            if (!atm) return;

            currentATMId = id;
            document.getElementById('modalTitle').textContent = 'Edit ATM';
            
            // Fill form with ATM data
            document.getElementById('atmId').value = atm.id;
            document.getElementById('atmName').value = atm.name;
            document.getElementById('atmAddress').value = atm.address;
            document.getElementById('atmStatus').value = atm.status;
            document.getElementById('acBrand').value = atm.acBrand || '';
            document.getElementById('acCapacity').value = atm.acCapacity || '';
            document.getElementById('acStatus').value = atm.acStatus;
            document.getElementById('acTemp').value = atm.acTemp;
            document.getElementById('lastService').value = atm.lastService || '';
            document.getElementById('nextService').value = atm.nextService || '';
            document.getElementById('acNotes').value = atm.acNotes || '';

            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('atmModal'));
            modal.show();
        }

        // Save ATM to Firebase
        async function saveATM() {
            const form = document.getElementById('atmForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Show loading
            const saveBtn = document.querySelector('#atmModal .btn-primary');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Menyimpan...';
            saveBtn.disabled = true;

            try {
                const formData = {
                    name: document.getElementById('atmName').value,
                    address: document.getElementById('atmAddress').value,
                    status: document.getElementById('atmStatus').value,
                    acBrand: document.getElementById('acBrand').value,
                    acCapacity: parseFloat(document.getElementById('acCapacity').value) || null,
                    acStatus: document.getElementById('acStatus').value,
                    acTemp: parseInt(document.getElementById('acTemp').value),
                    lastService: document.getElementById('lastService').value,
                    nextService: document.getElementById('nextService').value,
                    acNotes: document.getElementById('acNotes').value,
                    updatedAt: new Date().toISOString()
                };

                if (currentATMId) {
                    // Update existing ATM
                    await window.updateDoc(window.doc(window.db, "atms", currentATMId), formData);
                    showToast('success', 'Data ATM berhasil diperbarui');
                } else {
                    // Add new ATM
                    formData.createdAt = new Date().toISOString();
                    formData.history = [];
                    await window.addDoc(window.collection(window.db, "atms"), formData);
                    showToast('success', 'ATM baru berhasil ditambahkan');
                }

                // Hide modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('atmModal'));
                modal.hide();

            } catch (error) {
                console.error("Error saving ATM:", error);
                showToast('error', 'Gagal menyimpan data ATM');
            } finally {
                // Reset button
                saveBtn.innerHTML = originalText;
                saveBtn.disabled = false;
            }
        }

        // Delete ATM from Firebase
        async function deleteATM(id) {
            if (!confirm('Yakin ingin menghapus ATM ini? Data akan dihapus permanen dari Firebase.')) {
                return;
            }

            try {
                await window.deleteDoc(window.doc(window.db, "atms", id));
                showToast('success', 'ATM berhasil dihapus dari Firebase');
            } catch (error) {
                console.error("Error deleting ATM:", error);
                showToast('error', 'Gagal menghapus ATM dari Firebase');
            }
        }

        // View History
        function viewHistory(id) {
            const atm = atmData.find(a => a.id === id);
            if (!atm) return;

            currentATMId = id;
            document.querySelector('#historyModal .modal-title').innerHTML = 
                `<i class="fas fa-history"></i> Riwayat ${atm.name}`;
            
            renderHistory(atm.history);
            
            const modal = new bootstrap.Modal(document.getElementById('historyModal'));
            modal.show();
        }

        // Render History
        function renderHistory(history) {
            console.log('Rendering history:', history);
            const historyList = document.getElementById('historyList');
            historyList.innerHTML = '';

            if (!history || history.length === 0) {
                historyList.innerHTML = '<p class="text-center text-muted">Belum ada riwayat</p>';
                return;
            }

            // Create a copy and reverse to show newest first
            const sortedHistory = [...history].reverse();
            
            sortedHistory.forEach((item, index) => {
                const originalIndex = history.length - 1 - index;
                const historyItem = `
                    <div class="history-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="mb-1">${new Date(item.date).toLocaleDateString('id-ID', {
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric'
                                })}</h6>
                                <p class="mb-0">${item.entry}</p>
                            </div>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteHistoryEntry(${originalIndex})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
                historyList.innerHTML += historyItem;
            });
        }

        // Add History Entry to Firebase
        async function addHistoryEntry() {
            const entry = document.getElementById('newHistoryEntry').value.trim();
            if (!entry || !currentATMId) return;

            try {
                const atm = atmData.find(a => a.id === currentATMId);
                if (!atm) return;

                const newEntry = {
                    date: new Date().toISOString().split('T')[0],
                    entry: entry
                };

                const updatedHistory = [...(atm.history || []), newEntry];
                
                await window.updateDoc(window.doc(window.db, "atms", currentATMId), {
                    history: updatedHistory,
                    updatedAt: new Date().toISOString()
                });

                document.getElementById('newHistoryEntry').value = '';
                showToast('success', 'Riwayat berhasil ditambahkan');
                
                // Update local data and re-render
                atm.history = updatedHistory;
                renderHistory(atm.history);

            } catch (error) {
                console.error("Error adding history:", error);
                showToast('error', 'Gagal menambahkan riwayat');
            }
        }

        // Delete History Entry from Firebase
        async function deleteHistoryEntry(index) {
            if (!currentATMId) return;

            try {
                const atm = atmData.find(a => a.id === currentATMId);
                if (!atm || !atm.history) return;

                const updatedHistory = [...atm.history];
                updatedHistory.splice(index, 1);

                await window.updateDoc(window.doc(window.db, "atms", currentATMId), {
                    history: updatedHistory,
                    updatedAt: new Date().toISOString()
                });

                showToast('success', 'Riwayat berhasil dihapus');
                
                // Update local data and re-render
                atm.history = updatedHistory;
                renderHistory(atm.history);

            } catch (error) {
                console.error("Error deleting history:", error);
                showToast('error', 'Gagal menghapus riwayat');
            }
        }

        // Export data to CSV
        function exportToCSV() {
            if (atmData.length === 0) {
                showToast('error', 'Tidak ada data untuk diekspor');
                return;
            }

            // Prepare CSV data
            const csvData = atmData.map(atm => ({
                'Nama ATM': atm.name,
                'Alamat': atm.address,
                'Status ATM': atm.status,
                'Merk AC': atm.acBrand || '',
                'Kapasitas AC (PK)': atm.acCapacity || '',
                'Status AC': atm.acStatus,
                'Suhu Target': atm.acTemp + '°C',
                'Service Terakhir': atm.lastService || '',
                'Service Berikutnya': atm.nextService || '',
                'Catatan AC': atm.acNotes || '',
                'Jumlah Riwayat': atm.history ? atm.history.length : 0,
                'Dibuat': new Date(atm.createdAt).toLocaleDateString('id-ID'),
                'Diupdate': atm.updatedAt ? new Date(atm.updatedAt).toLocaleDateString('id-ID') : ''
            }));

            // Convert to CSV
            const headers = Object.keys(csvData[0]);
            const csvContent = [
                headers.join(','),
                ...csvData.map(row => headers.map(header => {
                    const value = row[header];
                    // Escape commas and quotes
                    return typeof value === 'string' && (value.includes(',') || value.includes('"')) 
                        ? `"${value.replace(/"/g, '""')}"` 
                        : value;
                }).join(','))
            ].join('\n');

            // Download file
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `data-atm-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showToast('success', 'Data ATM berhasil diekspor ke CSV');
        }

        // Show Toast
        function showToast(type, message) {
            const toastId = type === 'success' ? 'successToast' : 'errorToast';
            const messageId = type === 'success' ? 'successMessage' : 'errorMessage';
            
            document.getElementById(messageId).textContent = message;
            
            const toast = new bootstrap.Toast(document.getElementById(toastId));
            toast.show();
        }
    </script>
</body>
</html>
